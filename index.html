<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>AJAX CMS</title>
		
		<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
		<script src="https://code.jquery.com/ui/1.12.0-rc.2/jquery-ui.min.js"   integrity="sha256-55Jz3pBCF8z9jBO1qQ7cIf0L+neuPTD1u7Ytzrp2dqo="   crossorigin="anonymous"></script>  

		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
		
		<link href="https://bootswatch.com/cerulean/bootstrap.min.css" type="text/css" rel='stylesheet'>
	</head>
	
	<body>
		<div class="container">
			<header>
			</header>
			
			<!-- Static navbar -->
			<nav class="navbar navbar-default">
				<div class="container-fluid">
				  <div class="navbar-header">
				    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				      <span class="sr-only">Toggle navigation</span>
				      <span class="icon-bar"></span>
				      <span class="icon-bar"></span>
				      <span class="icon-bar"></span>
				    </button>
				    <a class="navbar-brand" href="#">AJAX CMS</a>
				  </div>
				  <div id="navbar" class="navbar-collapse collapse">
				    <ul id='menu' class="nav navbar-nav">
				    	<!-- Pages get inserted here to make menu -->
				    </ul>
				  </div><!--/.nav-collapse -->
				</div><!--/.container-fluid -->
			</nav>
			
			<main style="background-color:#FAA; position:relative;">
				<div id='a' style="position:absolute; "></div>
				<div id='b' style="position:absolute; display:none;"></div>
			</main>
			
			<footer>
			</footer>
		</div>
	</body>

	<script>
		var pages = [];
		var count = 0; // Keep track of recursive asyncronous directory list.
		var load_transition = "slide";
		var base_url = window.location.href.replace(/\?.*/,'');
		var params = window.location.href.replace(/.*\?/,'').split('&');
		
		// return url parameter value
		function param(key) {
			for (i=0; i<params.length; i++) {
				x = params[i].split("=");
				if (x[0] == key) {return x[1]}
			}
		}
		
		// Pages
		function findPages(p) {
			return $.grep(p, function(n,i){
				return /\.html$/.test(n)
			});
		}
		
		// Parse apache directory listing data... add to pages
		function parsedir(url) {
			url = url.replace(/\/$/,''); // Remove trailing slash from starting point url
			count++;
			$.get( url, function( data ) {
				var f;
				var rows = $(data).find('tr');
				for (i = 3; i < rows.length - 1; i++) {
					f = $(rows[i]).find('td a')[0].innerHTML
					pages.push(url+'/'+f);
					// Call directory recursively.
					if (/\/$/.test(f)) { // if file list ends in / then it is a dir
						parsedir(url+'/'+f);
					}
				}
			}).then(function(){
				count--;
				// Only call when the full directory list is parsed.
				if (count == 0) {
					pages.sort();
					makemenu();
					
					p = param('page');
					if (p) {
						loadPage(p, true);
					} else {
						loadPage(findPages(pages)[0], true); // Load the first page (home page) on init.
					}
				}
			});
		}
		
		// Define functions for load transitions.
		function loadPageBasic(url) {
			$.get( url, function( data ) {
			  $("main").html( data );
			});
		}
		
		function loadPageSlide(url) {
			$.get( url, function( data ) {
				$("#b").html( data )
			}).then(function(){
				  $("#a").hide("slide", { direction: "left"}, 500);
				  $("#b").show("slide", { direction: "right", complete: function(){
					  $("#a").html($('#b').html());
					  $("#a").show();
					  $("#b").hide();	
				  } }, 500);
				  
			});
		}
		
		// Set load_transition variable at top to set transition type for page loads.
		function loadPage(url,save) {
			console.log('url: '+ url);
			switch(load_transition) {
				case 'basic':
					loadPageBasic(url)
					break;
				case 'slide':
					loadPageSlide(url);
					break;
				default:
					loadPageBasic(url);
			}
			
			if (save == undefined || save == true) {
				var old_url = window.location.href
				var new_url = base_url+'?page='+url.replace(/^\.\//,'');
				console.log('state pushed');
				window.history.pushState({page: new_url},'test',new_url);
			}
		};
		
		// Put the pages in the menu (can only be two levels deep)
	    function makemenu() {
		    $.each(pages, function(index,file){
		    	var filename = file;
		    	
		    	filename = filename.replace(/\.\/pages\//,''); // Remove ./pages from beginning
		    	filename = filename.replace(/\d+\-/,'');       // Remove any digits followed by a dash at the beginning (use for sort)
		    	filename = filename.replace(/\.html$/,'');     // Remove .html from end.
		    	
		    	if (/\/$/.test(filename)) { 
		    		// It is a directory
		    		$('#menu').append(
		    			'<li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">'
		    			+ filename.replace(/\/$/,'')
		    			+ '<span class="caret"></span></a><ul class="dropdown-menu" id="'+filename+'"></ul></li>'
		    		);
		    	} else {
		    		// It is a file
		    		var parts = filename.split('/');
		    		if (parts.length > 1) {
		    			$('#'+parts[0]+'\\\/').append('<li class="file"><a onclick="loadPage(\''+file.replace(/\//g,'\\\/')+'\');">'+parts[1].replace(/\d+\-/,'')+'</a></li>');
		    		} else {
						$('#menu').append('<li class="file"><a onclick="loadPage(\''+file.replace(/\//g,'\\\/')+'\');">'+filename+'</a></li>');
		    		}
		    	}
			});
	    }
	    
	    // Back button clicked
	    $(window).on("popstate", function(e) {
	    	page = e.originalEvent.state.page
		    loadPage('./' + /(.*)\?page\=(.*)/.exec(page)[2],false); // the part after the ?page=
		});

		// Get the pages
		parsedir('./pages');
		
	</script>
</html>